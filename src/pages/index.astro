---
import Layout from '../layouts/Layout.astro';

// Placeholder data for trips
const trips = [
  {
    id: 1,
    title: 'Summer in Italy',
    location: 'Amalfi Coast',
    image: 'https://images.unsplash.com/photo-1533105079780-92b9be482077?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1533105079780-92b9be482077?q=80&w=1600&auto=format&fit=crop',
    date: 'June 2024',
    isNight: false,
    size: 'tall'
  },
  {
    id: 2,
    title: 'Hiking the Alps',
    location: 'Switzerland',
    image: 'https://images.unsplash.com/photo-1530122037265-a5f1f91d3b99?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1530122037265-a5f1f91d3b99?q=80&w=1600&auto=format&fit=crop',
    date: 'August 2024',
    isNight: false,
    size: 'normal'
  },
  {
    id: 3,
    title: 'City Lights',
    location: 'Tokyo, Japan',
    image: 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1540959733332-eab4deabeeaf?q=80&w=1600&auto=format&fit=crop',
    date: 'October 2023',
    isNight: true,
    size: 'wide'
  },
  {
    id: 4,
    title: 'Desert Vibes',
    location: 'Joshua Tree',
    image: 'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1505118380757-91f5f5632de0?q=80&w=1600&auto=format&fit=crop',
    date: 'March 2024',
    isNight: false,
    size: 'normal'
  },
  {
    id: 5,
    title: 'Island Hopping',
    location: 'Greece',
    image: 'https://images.unsplash.com/photo-1533105079780-92b9be482077?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1533105079780-92b9be482077?q=80&w=1600&auto=format&fit=crop',
    date: 'July 2023',
    isNight: false,
    size: 'big'
  },
  {
    id: 6,
    title: 'Nordic Escape',
    location: 'Iceland',
    image: 'https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1476610182048-b716b8518aae?q=80&w=1600&auto=format&fit=crop',
    date: 'December 2023',
    isNight: false,
    size: 'wide'
  },
  {
    id: 7,
    title: 'Midnight in Paris',
    location: 'France',
    image: 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1502602898657-3e91760cbb34?q=80&w=1600&auto=format&fit=crop',
    date: 'September 2023',
    isNight: true,
    size: 'tall'
  },
  {
    id: 8,
    title: 'Neon Dreams',
    location: 'Hong Kong',
    image: 'https://images.unsplash.com/photo-1506318137071-a8bcbf67cc77?q=80&w=1200&auto=format&fit=crop',
    fullRes: 'https://images.unsplash.com/photo-1506318137071-a8bcbf67cc77?q=80&w=1600&auto=format&fit=crop',
    date: 'November 2023',
    isNight: true,
    size: 'normal'
  }
];

const getSizeClass = (size) => {
  switch (size) {
    case 'wide': return 'md:col-span-2';
    case 'tall': return 'md:row-span-2';
    case 'big': return 'md:col-span-2 md:row-span-2';
    default: return '';
  }
};
---

<Layout title="Home">
  <div class="page-container">
    <div class="section-header animate-fade-in-down">
      <h1 class="page-title">Travel Journal</h1>
      <p class="page-subtitle">
        Collecting moments and memories from around the world.
      </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 grid-flow-dense" id="trips-grid">
      {trips.map((trip) => (
        <div 
          class={`trip-card trip-card-base group opacity-0 translate-y-8 ${getSizeClass(trip.size)}`}
          data-full-res={trip.fullRes}
          data-title={trip.title}
          data-location={trip.location}
          data-is-night={trip.isNight.toString()}
        >
          <div class="w-full h-full bg-gray-200">
             <img 
              src={trip.image} 
              alt={trip.title}
              class="object-cover w-full h-full min-h-96 group-hover:scale-105 transition-transform duration-700 ease-in-out"
              loading="lazy"
            />
          </div>
          <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent p-6 text-white opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity duration-300 pointer-events-none">
            <h3 class="text-xl font-bold">{trip.title}</h3>
            <p class="text-sm font-medium opacity-90">{trip.location} &bull; {trip.date}</p>
          </div>
        </div>
      ))}
    </div>
  </div>

  <!-- Lightbox Modal -->
  <div id="lightbox" class="fixed inset-0 z-[100] hidden bg-black/90 backdrop-blur-sm transition-opacity duration-300 opacity-0" aria-hidden="true">
    <!-- Close button -->
    <button id="lightbox-close" class="absolute top-4 right-4 text-white hover:text-gray-300 focus:outline-none z-50 p-2">
      <span class="sr-only">Close</span>
      <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Navigation Buttons -->
    <button id="lightbox-prev" class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 focus:outline-none z-50 p-4 hidden sm:block">
      <span class="sr-only">Previous</span>
      <svg class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
      </svg>
    </button>
    
    <button id="lightbox-next" class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white hover:text-gray-300 focus:outline-none z-50 p-4 hidden sm:block">
      <span class="sr-only">Next</span>
      <svg class="h-10 w-10" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
      </svg>
    </button>

    <!-- Content -->
    <div class="flex items-center justify-center h-full w-full p-4">
      <img id="lightbox-img" src="" alt="" class="max-h-[85vh] max-w-[90vw] object-contain shadow-2xl rounded-sm transform scale-95 transition-transform duration-300 select-none" />
      
      <!-- Gradient Overlay for better text readability -->
      <div class="absolute bottom-0 left-0 right-0 h-48 bg-gradient-to-t from-black/90 via-black/50 to-transparent pointer-events-none"></div>

      <div class="absolute bottom-8 left-0 right-0 text-center text-white pointer-events-none px-4">
          <h3 id="lightbox-title" class="text-2xl font-serif font-bold tracking-wide drop-shadow-lg"></h3>
          <p id="lightbox-location" class="text-lg opacity-90 mt-2 drop-shadow-md font-medium"></p>
      </div>
    </div>
  </div>
</Layout>

<script>
  // Function to setup all interactivity
  function setupInteractivity() {
    // --- Scroll Animations ---
    const observerOptions = {
      root: null,
      rootMargin: '0px',
      threshold: 0.1
    };

    const cards = document.querySelectorAll('.trip-card');
    const cardsArray = Array.from(cards);

    const observer = new IntersectionObserver((entries) => {
      // Get all intersecting entries
      const intersecting = entries.filter(e => e.isIntersecting);
      
      // Sort them by their position in the DOM to ensure top-to-bottom animation
      intersecting.sort((a, b) => {
          return cardsArray.indexOf(a.target) - cardsArray.indexOf(b.target);
      });

      // Animate them one after another
      intersecting.forEach((entry, index) => {
        const target = entry.target as HTMLElement;
        // Stagger the delay based on the index WITHIN this batch
        target.style.transitionDelay = `${index * 150}ms`; 
        target.classList.remove('opacity-0', 'translate-y-8');
        observer.unobserve(target);
      });
    }, observerOptions);

    // Store original cards list for lightbox navigation context
    let visibleCards: Element[] = Array.from(cards);
    
    cards.forEach((card) => {
      // Remove any pre-existing delay so we control it dynamically
      (card as HTMLElement).style.transitionDelay = '0ms';
      observer.observe(card);
    });

    // --- Filter Logic ---
    
    const filterCards = (theme: string) => {
        const isNightMode = theme === 'dark';
        
        // Reset animation delays for smoother re-appearance
        cards.forEach((card) => {
             (card as HTMLElement).style.transitionDelay = '0ms';
        });

        visibleCards = []; // Reset visible list for lightbox

        cards.forEach((card) => {
            const isNight = card.getAttribute('data-is-night') === 'true';
            
            if (isNightMode) {
                // Night mode: Show ONLY night images
                if (isNight) {
                    card.classList.remove('hidden');
                    visibleCards.push(card);
                } else {
                    card.classList.add('hidden');
                }
            } else {
                // Day mode: Show ALL images
                card.classList.remove('hidden');
                visibleCards.push(card);
            }
        });
    };

    // Listen for global theme changes
    window.addEventListener('theme-change', (e: any) => {
        filterCards(e.detail.theme);
    });

    // Initial filter check
    const currentTheme = document.documentElement.classList.contains('dark') ? 'dark' : 'light';
    filterCards(currentTheme);

    // --- Lightbox ---
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img') as HTMLImageElement;
    const lightboxTitle = document.getElementById('lightbox-title');
    const lightboxLocation = document.getElementById('lightbox-location');
    const closeBtn = document.getElementById('lightbox-close');
    const prevBtn = document.getElementById('lightbox-prev');
    const nextBtn = document.getElementById('lightbox-next');

    let currentVisibleIndex = 0;

    if (!lightbox || !lightboxImg || !closeBtn || !prevBtn || !nextBtn) return;

    const preloadImage = (url: string) => {
        const img = new Image();
        img.src = url;
    };

    const updateLightboxImage = (index: number) => {
        const card = visibleCards[index];
        if (!card) return;

        const imgUrl = card.getAttribute('data-full-res');
        const title = card.getAttribute('data-title') || '';
        const location = card.getAttribute('data-location') || '';

        lightboxImg.style.opacity = '0.5';
        
        setTimeout(() => {
            if (imgUrl) lightboxImg.src = imgUrl;
            if (lightboxTitle) lightboxTitle.textContent = title;
            if (lightboxLocation) lightboxLocation.textContent = location;
            lightboxImg.style.opacity = '1';
        }, 150);

        currentVisibleIndex = index;

        // Preload based on VISIBLE cards
        const nextIndex = (index + 1) % visibleCards.length;
        const prevIndex = (index - 1 + visibleCards.length) % visibleCards.length;
        
        const nextUrl = visibleCards[nextIndex]?.getAttribute('data-full-res');
        const prevUrl = visibleCards[prevIndex]?.getAttribute('data-full-res');

        if (nextUrl) preloadImage(nextUrl);
        if (prevUrl) preloadImage(prevUrl);
    };

    const openLightbox = (card: Element) => {
      // Find index of this card in the currently visible list
      const index = visibleCards.indexOf(card);
      if (index === -1) return;

      updateLightboxImage(index);
      
      lightbox.classList.remove('hidden');
      requestAnimationFrame(() => {
        lightbox.classList.remove('opacity-0');
        lightboxImg.classList.remove('scale-95');
        lightboxImg.classList.add('scale-100');
      });
      document.body.style.overflow = 'hidden';
    };

    const closeLightbox = () => {
      lightbox.classList.add('opacity-0');
      lightboxImg.classList.remove('scale-100');
      lightboxImg.classList.add('scale-95');
      
      setTimeout(() => {
        lightbox.classList.add('hidden');
        lightboxImg.src = '';
        document.body.style.overflow = '';
      }, 300);
    };

    const showNext = (e?: Event) => {
        e?.stopPropagation();
        let newIndex = currentVisibleIndex + 1;
        if (newIndex >= visibleCards.length) newIndex = 0;
        updateLightboxImage(newIndex);
    };

    const showPrev = (e?: Event) => {
        e?.stopPropagation();
        let newIndex = currentVisibleIndex - 1;
        if (newIndex < 0) newIndex = visibleCards.length - 1;
        updateLightboxImage(newIndex);
    };

    // Attach click events to cards
    cards.forEach((card) => {
      card.addEventListener('click', () => {
          openLightbox(card);
      });
    });

    // Close events
    closeBtn.addEventListener('click', closeLightbox);
    
    // Navigation events
    nextBtn.addEventListener('click', showNext);
    prevBtn.addEventListener('click', showPrev);

    // Close on background click
    lightbox.addEventListener('click', (e) => {
        const target = e.target as HTMLElement;
        if (target === lightbox || target.closest('.flex')) {
             if (target !== lightboxImg && !target.closest('button')) {
                 closeLightbox();
             }
        }
    });

    // Keyboard events
    document.addEventListener('keydown', (e) => {
      if (lightbox.classList.contains('hidden')) return;

      if (e.key === 'Escape') {
        closeLightbox();
      } else if (e.key === 'ArrowRight') {
        showNext();
      } else if (e.key === 'ArrowLeft') {
        showPrev();
      }
    });
  }

  // Run on initial load
  setupInteractivity();

  // Run on view transition navigation
  document.addEventListener('astro:page-load', setupInteractivity);
</script>